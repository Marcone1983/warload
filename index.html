<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COSMIC WARLORDS: ELITE</title>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- External Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --neon-cyan: #00f3ff;
            --neon-magenta: #ff00ff;
            --neon-gold: #ffd700;
            --ton-blue: #0098EA;
            --bg-deep: #050508;
        }

        body {
            margin: 0; overflow: hidden; background: var(--bg-deep); color: white;
            font-family: 'Rajdhani', sans-serif; touch-action: none; user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        /* UI Glassmorphism */
        .glass-panel {
            background: rgba(10, 15, 30, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        /* Buttons */
        .btn-cyber {
            position: relative; overflow: hidden; transition: all 0.3s ease;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            text-transform: uppercase; font-family: 'Orbitron', sans-serif; font-weight: 700; cursor: pointer;
        }
        .btn-cyber:active { transform: scale(0.96); }
        .btn-start { background: linear-gradient(90deg, var(--neon-cyan), #0066ff); color: black; }

        /* Animations */
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scanlines::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px; z-index: 2; pointer-events: none;
        }

        /* Joystick & UI */
        .joystick-zone { position: absolute; width: 140px; height: 140px; border-radius: 50%; border: 2px dashed rgba(255,255,255,0.1); pointer-events: auto; }
        .joystick-knob { width: 50px; height: 50px; border-radius: 50%; background: rgba(0, 243, 255, 0.5); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--neon-cyan); }
        .full-screen { position: absolute; inset: 0; z-index: 50; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="scanlines">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen" class="full-screen bg-black items-center justify-center z-[100]">
        <div class="text-center">
            <h1 class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 font-['Orbitron'] tracking-wider mb-4">WARLOAD</h1>
            <div class="w-64 h-1 bg-gray-800 mx-auto rounded overflow-hidden mt-4">
                <div id="loader-bar" class="h-full bg-cyan-500 w-0 transition-all duration-1000"></div>
            </div>
            <p class="text-xs text-cyan-500 mt-2 font-mono">INITIALIZING GROWVERSE SYSTEMS...</p>
        </div>
    </div>

    <!-- MAIN MENU -->
    <div id="main-menu" class="full-screen items-center justify-center hidden bg-[url('https://images.unsplash.com/photo-1506318137071-a8bcbf6755dd?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div class="relative z-10 w-full max-w-md p-6 flex flex-col gap-4">
            
            <!-- Header Profile -->
            <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gray-700 border border-cyan-500 overflow-hidden">
                        <img id="tg-avatar-img" class="w-full h-full object-cover hidden">
                    </div>
                    <div>
                        <div id="user-name" class="font-bold text-cyan-400">Guest Pilot</div>
                        <div class="text-xs text-gray-400">Level <span id="user-level">1</span></div>
                    </div>
                </div>
                <div class="text-yellow-400 font-mono text-xl">ðŸª™ <span id="credits-display">0</span></div>
            </div>

            <!-- Start Button -->
            <button onclick="Game.start()" class="btn-cyber btn-start py-5 text-2xl tracking-widest shadow-[0_0_30px_rgba(0,243,255,0.4)]">
                <i class="fa-solid fa-rocket mr-2"></i> START MISSION
            </button>

            <!-- Menu Grid -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="Market.open()" class="btn-cyber glass-panel py-4 text-yellow-400 border border-yellow-500/30">
                    <i class="fa-solid fa-cart-shopping"></i> ARMORY
                </button>
                <button onclick="Game.multiplayerLobby()" class="btn-cyber glass-panel py-4 text-purple-400 border border-purple-500/30">
                    <i class="fa-solid fa-users"></i> MULTIPLAYER
                </button>
            </div>
        </div>
    </div>

    <!-- MARKETPLACE MODAL -->
    <div id="market-modal" class="full-screen bg-black/95 z-[60] hidden p-4 overflow-y-auto">
        <div class="max-w-2xl mx-auto w-full">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-black/90 py-4 z-10 border-b border-gray-800">
                <h2 class="text-2xl font-['Orbitron'] text-yellow-400">MARKETPLACE</h2>
                <button onclick="Market.close()" class="text-gray-400 text-xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <!-- Tabs -->
            <div class="flex gap-2 mb-6">
                <button onclick="Market.switchTab('ships')" class="flex-1 py-2 bg-gray-800 rounded hover:bg-gray-700 text-sm font-bold border-b-2 border-cyan-500">SHIPS</button>
                <button onclick="Market.switchTab('credits')" class="flex-1 py-2 bg-gray-800 rounded hover:bg-gray-700 text-sm text-gray-400">CREDITS</button>
            </div>
            <div id="market-content" class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-20"></div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="payment-modal" class="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center hidden p-4 backdrop-blur">
        <div class="glass-panel p-6 rounded-xl max-w-sm w-full border border-gray-700 relative">
            <button onclick="document.getElementById('payment-modal').classList.add('hidden')" class="absolute top-2 right-4 text-gray-500 text-2xl">&times;</button>
            <h3 class="text-xl font-bold mb-1 text-white" id="pay-item-name">Item</h3>
            <p class="text-gray-400 text-xs mb-6">Secure Checkout</p>
            <div class="space-y-3">
                <button onclick="Payments.payTon()" class="w-full py-4 rounded-lg bg-[#0098EA] text-white font-bold flex justify-between px-4">
                    <span><i class="fa-solid fa-diamond"></i> Pay with TON</span>
                    <span class="bg-white/20 px-2 py-1 rounded text-xs" id="pay-price-ton">0.5 TON</span>
                </button>
                <button onclick="Payments.payUsdt()" class="w-full py-4 rounded-lg bg-[#26A17B] text-white font-bold flex justify-between px-4">
                    <span><i class="fa-solid fa-dollar-sign"></i> Pay with USDT</span>
                    <span class="bg-white/20 px-2 py-1 rounded text-xs" id="pay-price-usdt">1.00 USD</span>
                </button>
            </div>
            <div id="crypto-address-box" class="hidden mt-4 p-3 bg-gray-900 rounded border border-dashed border-gray-600 text-center">
                <p class="text-[10px] text-gray-400 mb-1">SEND USDT (EVM) TO:</p>
                <p class="text-xs font-mono text-green-400 break-all select-all cursor-pointer" onclick="Payments.copyAddr()">0xC69088eB5F015Fca5B385b8E3A0463749813093e</p>
            </div>
        </div>
    </div>

    <!-- GAME HUD & CANVAS -->
    <div id="game-hud" class="absolute inset-0 pointer-events-none hidden z-40">
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent">
            <div>
                <div class="h-2 w-32 bg-gray-800 rounded border border-gray-600 overflow-hidden"><div id="hud-hp" class="h-full bg-red-500 w-full"></div></div>
                <div class="text-xs text-gray-400 mt-1">SHIELD</div>
            </div>
            <div class="text-2xl font-['Orbitron'] font-bold" id="hud-score">0</div>
            <button onclick="Game.pause()" class="pointer-events-auto text-white text-xl"><i class="fa-solid fa-pause"></i></button>
        </div>
        <!-- Mobile Controls -->
        <div id="mobile-controls" class="absolute inset-0 pointer-events-none">
            <div id="stick-move" class="joystick-zone bottom-8 left-8 hidden md:hidden"><div class="joystick-knob"></div></div>
            <div id="btn-fire" class="absolute bottom-8 right-8 w-24 h-24 rounded-full bg-red-500/20 border-2 border-red-500 flex items-center justify-center text-red-200 pointer-events-auto active:bg-red-500/50 hidden md:hidden"><i class="fa-solid fa-crosshairs text-3xl"></i></div>
        </div>
    </div>

    <canvas id="gameCanvas" class="absolute inset-0 z-0"></canvas>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // --- CONFIGURAZIONE REALE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCgiM0KznUry9XY4v38XEOCc_cAHeKUsK4",
          authDomain: "warload-1c43f.firebaseapp.com",
          projectId: "warload-1c43f",
          storageBucket: "warload-1c43f.firebasestorage.app",
          messagingSenderId: "346876991112",
          appId: "1:346876991112:web:2b9e46b59ee7d23c6ab13d",
          databaseURL: "https://warload-1c43f-default-rtdb.europe-west1.firebasedatabase.app" // ATTENZIONE: Assicurati che questo URL sia corretto dalla console
        };

        // Inizializza Firebase
        let app, db, auth, myPlayerId, otherPlayers = {};
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized");
        } catch(e) {
            console.error("Firebase Init Error:", e);
        }

        const TG = window.Telegram.WebApp;
        TG.expand();

        // --- PLAYER DATA ---
        const PlayerProfile = {
            credits: 0,
            inventory: ['ship_default'],
            async init() {
                // Load from CloudStorage or Local
                const saved = localStorage.getItem('cw_profile');
                if(saved) Object.assign(this, JSON.parse(saved));
                this.updateUI();
            },
            addCredits(amount) {
                this.credits += amount;
                this.save();
            },
            save() {
                localStorage.setItem('cw_profile', JSON.stringify(this));
                this.updateUI();
            },
            updateUI() {
                document.getElementById('credits-display').innerText = this.credits;
                document.getElementById('user-level').innerText = Math.floor(this.credits/1000)+1;
                if(TG.initDataUnsafe?.user) {
                    document.getElementById('user-name').innerText = TG.initDataUnsafe.user.first_name;
                }
            }
        };

        // --- MARKET ---
        const Items = [
            { id: 'ship_tank', name: 'Titan Hull', type: 'ships', priceTon: 1.5, priceUsdt: 3.0, stats: 'Armor +++' },
            { id: 'cred_pack_1', name: '1000 Credits', type: 'credits', priceTon: 0.1, priceUsdt: 0.2, stats: 'Currency' }
        ];
        let pendingItem = null;

        window.Market = {
            open: () => {
                document.getElementById('market-modal').classList.remove('hidden');
                window.Market.switchTab('ships');
            },
            close: () => document.getElementById('market-modal').classList.add('hidden'),
            switchTab: (type) => {
                const container = document.getElementById('market-content');
                container.innerHTML = '';
                Items.filter(i => i.type === type).forEach(item => {
                    const card = document.createElement('div');
                    card.className = `glass-panel p-4 rounded border border-gray-700 flex flex-col gap-2`;
                    card.innerHTML = `
                        <h3 class="font-bold text-white">${item.name}</h3>
                        <p class="text-xs text-gray-400">${item.stats}</p>
                        <button onclick="window.Payments.init('${item.id}')" class="btn-cyber py-2 text-xs bg-yellow-600 text-black font-bold">BUY</button>
                    `;
                    container.appendChild(card);
                });
            }
        };

        window.Payments = {
            init: (itemId) => {
                pendingItem = Items.find(i => i.id === itemId);
                if(!pendingItem) return;
                document.getElementById('pay-item-name').innerText = pendingItem.name;
                document.getElementById('pay-price-ton').innerText = pendingItem.priceTon + " TON";
                document.getElementById('pay-price-usdt').innerText = pendingItem.priceUsdt + " USD";
                document.getElementById('payment-modal').classList.remove('hidden');
            },
            payTon: () => {
                const amountNano = pendingItem.priceTon * 1000000000;
                window.location.href = `ton://transfer/UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR?amount=${amountNano}`;
                setTimeout(() => { if(confirm("Payment sent?")) window.Payments.complete(); }, 3000);
            },
            payUsdt: () => { document.getElementById('crypto-address-box').classList.remove('hidden'); },
            copyAddr: () => {
                navigator.clipboard.writeText("0xC69088eB5F015Fca5B385b8E3A0463749813093e");
                alert("Address Copied!");
                setTimeout(() => { if(confirm("Payment sent?")) window.Payments.complete(); }, 5000);
            },
            complete: () => {
                if(pendingItem.type === 'credits') PlayerProfile.addCredits(1000);
                document.getElementById('payment-modal').classList.add('hidden');
                alert("Purchased!");
                PlayerProfile.save();
            }
        };

        // --- GAME ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, state = 'MENU';
        let player = { x:0, y:0, angle:0, vx:0, vy:0, hp:100 };
        let bullets=[], enemies=[], particles=[], camera={x:0, y:0, shake:0};
        const keys = {}, touchInput = { active: false, moveX: 0, moveY: 0, fire: false };

        window.Game = {
            init: async () => {
                window.addEventListener('resize', Game.resize);
                Game.resize();
                await PlayerProfile.init();
                document.getElementById('loader-bar').style.width = '100%';
                setTimeout(() => {
                    document.getElementById('splash-screen').classList.add('hidden');
                    document.getElementById('main-menu').classList.remove('hidden');
                }, 1500);
                Game.setupInputs();
            },
            resize: () => { width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; },
            start: () => {
                document.getElementById('main-menu').classList.add('hidden');
                document.getElementById('game-hud').classList.remove('hidden');
                state = 'PLAY';
                player.x=0; player.y=0; player.hp=100;
                enemies=[]; bullets=[];
                if(/Android|iPhone/i.test(navigator.userAgent)) {
                    document.getElementById('stick-move').classList.remove('hidden');
                    document.getElementById('btn-fire').classList.remove('hidden');
                }
                Game.loop();
                setInterval(() => { if(state==='PLAY' && enemies.length<10) Game.spawnEnemy(); }, 2000);
            },
            setupInputs: () => {
                window.addEventListener('keydown', e=>keys[e.code]=true);
                window.addEventListener('keyup', e=>keys[e.code]=false);
                const stick = document.getElementById('stick-move');
                const knob = stick.querySelector('.joystick-knob');
                stick.addEventListener('touchstart', e=>{ e.preventDefault(); touchInput.active=true; });
                stick.addEventListener('touchmove', e=>{
                    e.preventDefault(); const t=e.touches[0], r=stick.getBoundingClientRect();
                    const dx=t.clientX-(r.left+r.width/2), dy=t.clientY-(r.top+r.height/2);
                    const dist=Math.min(Math.sqrt(dx*dx+dy*dy), 50);
                    const ang=Math.atan2(dy, dx);
                    knob.style.transform=`translate(calc(-50% + ${Math.cos(ang)*dist}px), calc(-50% + ${Math.sin(ang)*dist}px))`;
                    touchInput.moveX=Math.cos(ang)*dist/50; touchInput.moveY=Math.sin(ang)*dist/50;
                });
                stick.addEventListener('touchend', ()=>{ touchInput.active=false; touchInput.moveX=0; touchInput.moveY=0; knob.style.transform=`translate(-50%, -50%)`; });
                const btnFire = document.getElementById('btn-fire');
                btnFire.addEventListener('touchstart', e=>{ e.preventDefault(); touchInput.fire=true; });
                btnFire.addEventListener('touchend', e=>{ e.preventDefault(); touchInput.fire=false; });
            },
            multiplayerLobby: async () => {
                if(!auth) return alert("Database not ready yet.");
                await signInAnonymously(auth);
                myPlayerId = auth.currentUser.uid;
                onValue(ref(db, 'players'), s => { otherPlayers = s.val() || {}; delete otherPlayers[myPlayerId]; });
                onDisconnect(ref(db, `players/${myPlayerId}`)).remove();
                alert("Connected to Multiplayer Server!");
                Game.start();
            },
            spawnEnemy: () => {
                const ang = Math.random()*Math.PI*2, dist = Math.max(width, height);
                enemies.push({ x: player.x+Math.cos(ang)*dist, y: player.y+Math.sin(ang)*dist, vx:0, vy:0, hp:20 });
            },
            loop: () => {
                if(state !== 'PLAY') return;
                requestAnimationFrame(Game.loop);
                // Update
                let dx=0, dy=0;
                if(keys['KeyW']) dy=-1; if(keys['KeyS']) dy=1; if(keys['KeyA']) dx=-1; if(keys['KeyD']) dx=1;
                if(touchInput.active) { dx=touchInput.moveX; dy=touchInput.moveY; }
                player.vx += dx*0.8; player.vy += dy*0.8;
                player.vx *= 0.92; player.vy *= 0.92;
                player.x += player.vx; player.y += player.vy;
                if(Math.abs(dx)>0.1 || Math.abs(dy)>0.1) player.angle = Math.atan2(dy, dx);
                
                // Camera
                camera.x += (player.x-width/2-camera.x)*0.1; camera.y += (player.y-height/2-camera.y)*0.1;
                
                // Shoot
                if((keys['Space'] || touchInput.fire) && (!player.cd || player.cd<=0)) {
                    bullets.push({x:player.x, y:player.y, vx:Math.cos(player.angle)*20+player.vx, vy:Math.sin(player.angle)*20+player.vy, life:100});
                    player.cd=10;
                }
                if(player.cd>0) player.cd--;

                // Enemies
                enemies.forEach(e => {
                    const ang = Math.atan2(player.y-e.y, player.x-e.x);
                    e.vx += Math.cos(ang)*0.2; e.vy += Math.sin(ang)*0.2;
                    e.vx *= 0.98; e.vy *= 0.98; e.x += e.vx; e.y += e.vy;
                    bullets.forEach((b,i) => { if(Math.hypot(b.x-e.x, b.y-e.y)<20) { e.hp-=10; bullets.splice(i,1); } });
                });
                enemies = enemies.filter(e => e.hp>0);

                // Multiplayer Sync
                if(myPlayerId && db) update(ref(db, `players/${myPlayerId}`), { x:Math.round(player.x), y:Math.round(player.y), angle:player.angle });

                // Draw
                ctx.fillStyle='#050508'; ctx.fillRect(0,0,width,height);
                ctx.save(); ctx.translate(-camera.x, -camera.y);
                
                // Grid
                ctx.strokeStyle='rgba(0,243,255,0.1)'; ctx.lineWidth=1;
                const gs=200, sx=Math.floor(camera.x/gs)*gs, sy=Math.floor(camera.y/gs)*gs;
                for(let x=sx; x<sx+width+gs; x+=gs) { ctx.beginPath(); ctx.moveTo(x,sy); ctx.lineTo(x,sy+height+gs); ctx.stroke(); }
                for(let y=sy; y<sy+height+gs; y+=gs) { ctx.beginPath(); ctx.moveTo(sx,y); ctx.lineTo(sx+width+gs,y); ctx.stroke(); }

                // Bullets
                ctx.fillStyle='#ffd700'; bullets.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x, b.y, 3, 0, Math.PI*2); ctx.fill(); b.x+=b.vx; b.y+=b.vy; b.life--; });
                bullets = bullets.filter(b=>b.life>0);

                // Enemies
                ctx.fillStyle='#ff0055'; enemies.forEach(e=>{
                    ctx.save(); ctx.translate(e.x, e.y); ctx.rotate(Math.atan2(e.vy, e.vx)+Math.PI/2);
                    ctx.beginPath(); ctx.moveTo(0,-15); ctx.lineTo(10,10); ctx.lineTo(-10,10); ctx.fill(); ctx.restore();
                });

                // Other Players
                ctx.strokeStyle='rgba(255,255,255,0.5)'; Object.values(otherPlayers).forEach(p=>{
                     ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle+Math.PI/2);
                     ctx.beginPath(); ctx.moveTo(0,-15); ctx.lineTo(10,10); ctx.lineTo(-10,10); ctx.stroke(); ctx.restore();
                });

                // Player
                ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle+Math.PI/2);
                ctx.fillStyle='#000'; ctx.strokeStyle='#00f3ff'; ctx.lineWidth=2;
                ctx.beginPath(); ctx.moveTo(0,-20); ctx.lineTo(15,15); ctx.lineTo(0,10); ctx.lineTo(-15,15); ctx.closePath(); ctx.fill(); ctx.stroke();
                ctx.restore();

                ctx.restore();
            }
        };

        window.onload = Game.init;
    </script>
</body>
</html>

